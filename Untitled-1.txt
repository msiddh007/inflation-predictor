import os
from datetime import datetime
import pandas as pd
from fredapi import Fred
from newsapi import NewsApiClient
from vaderSentiment.vaderSentiment import SentimentIntensityAnalyzer

# === CONFIGURATION ===
FRED_API_KEY = 'be0e147be18716db5ef460415b62aaec'
NEWS_API_KEY = 'c8bf5aea000846b6b6c67d97c2872fc6'
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
DATA_DIR = os.path.join(BASE_DIR, 'data', 'raw')
os.makedirs(DATA_DIR, exist_ok=True)

# === FRED Economic Indicators (replaced HPI with PPI) ===
fred = Fred(api_key=FRED_API_KEY)
fred_indicators = {
    'CPI': 'CPIAUCSL',
    'PCE': 'PCEPI',
    'PPI': 'PPIACO',  # All Commodities
    'Unemployment Rate': 'UNRATE',
    'Jobless Claims': 'ICSA'
}

def fetch_fred_data():
    print(f"[{datetime.now()}] Fetching FRED data...")
    data = {name: fred.get_series(code) for name, code in fred_indicators.items()}
    df = pd.DataFrame(data)
    df.index.name = 'Date'
    df.to_csv(os.path.join(DATA_DIR, 'fred_data.csv'))
    print(f"[{datetime.now()}] ✅ Saved FRED data to: fred_data.csv")

# === News Fetcher + Sentiment Scoring ===
newsapi = NewsApiClient(api_key=NEWS_API_KEY)
analyzer = SentimentIntensityAnalyzer()

def fetch_econ_news():
    print(f"[{datetime.now()}] Fetching news articles...")
    response = newsapi.get_everything(
        q='inflation OR unemployment OR economy OR fed OR tariffs',
        language='en',
        sort_by='publishedAt',
        page_size=100,
    )
    articles = response.get('articles', [])
    results = []
    for a in articles:
        text = f"{a.get('title', '')} {a.get('description', '')}".strip()
        sentiment = analyzer.polarity_scores(text)['compound']
        results.append({
            'title': a.get('title'),
            'description': a.get('description'),
            'publishedAt': a.get('publishedAt'),
            'source': a['source']['name'],
            'sentiment': sentiment
        })

    df = pd.DataFrame(results)
    df['publishedAt'] = pd.to_datetime(df['publishedAt'])
    df.to_csv(os.path.join(DATA_DIR, 'daily_news.csv'), index=False)
    print(f"[{datetime.now()}] ✅ Saved {len(df)} news articles with sentiment.")

if __name__ == '__main__':
    fetch_fred_data()
    fetch_econ_news()
